#!/bin/bash
# PICclock Configure Script

CONFIG_FILE="config.mk"
ERRORS=0

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

find_ipe() {
    if [ -n "$MPLAB_IPE" ] && [ -f "$MPLAB_IPE" ]; then
        echo "$MPLAB_IPE"
        return 0
    fi

    local search_paths=(
        /c/Program\ Files/Microchip/MPLABX/v*/mplab_platform/mplab_ipe
        /mnt/c/Program\ Files/Microchip/MPLABX/v*/mplab_platform/mplab_ipe
        /opt/microchip/mplabx/v*/mplab_platform/mplab_ipe
        /Applications/microchip/mplabx/v*/mplab_platform/mplab_ipe
    )

    for pattern in "${search_paths[@]}"; do
        for dir in $pattern; do
            if [ -f "$dir/ipecmd.jar" ]; then
                echo "$dir/ipecmd.jar"
                return 0
            fi
        done
    done
    return 1
}

find_dfp() {
    local search_paths=(
        /c/Program\ Files/Microchip/MPLABX/v*/packs/Microchip/PIC16Fxxx_DFP/*
        /mnt/c/Program\ Files/Microchip/MPLABX/v*/packs/Microchip/PIC16Fxxx_DFP/*
        /opt/microchip/mplabx/v*/packs/Microchip/PIC16Fxxx_DFP/*
        /Applications/microchip/mplabx/v*/packs/Microchip/PIC16Fxxx_DFP/*
        ~/.mchp_packs/Microchip/PIC16Fxxx_DFP/*
    )

    for pattern in "${search_paths[@]}"; do
        for dir in $(ls -d $pattern 2>/dev/null | sort -rV | head -1); do
            if [ -d "$dir/xc8" ]; then
                echo "$dir"
                return 0
            fi
        done
    done
    return 1
}

echo "PICclock Configure"
echo ""

echo -n "Checking for make... "
if command_exists make; then
    echo "found"
else
    echo "NOT FOUND"; ERRORS=$((ERRORS + 1))
fi

echo -n "Checking for java... "
if command_exists java; then
    echo "found"
else
    echo "NOT FOUND"; ERRORS=$((ERRORS + 1))
fi

echo -n "Checking for MPLAB IPE... "
IPE_PATH=$(find_ipe)
if [ -n "$IPE_PATH" ]; then
    echo "found: $IPE_PATH"
else
    echo "NOT FOUND"; ERRORS=$((ERRORS + 1))
fi

echo -n "Checking for xc8 compiler... "
if command_exists xc8-cc; then
    XC8_PATH=$(command -v xc8-cc)
    echo "found: $XC8_PATH"
elif command_exists xc8; then
    XC8_PATH=$(command -v xc8)
    echo "found: $XC8_PATH"
else
    echo "NOT FOUND"; ERRORS=$((ERRORS + 1))
fi

echo -n "Checking for PIC16Fxxx DFP... "
DFP_PATH=$(find_dfp)
if [ -n "$DFP_PATH" ]; then
    echo "found: $DFP_PATH"
else
    echo "NOT FOUND (install via MPLAB X IDE: Tools > Packs > PIC16Fxxx_DFP)"; ERRORS=$((ERRORS + 1))
fi

echo ""

if [ $ERRORS -gt 0 ]; then
    echo "Configuration FAILED: $ERRORS required tool(s) not found"
    exit 1
fi

echo "Writing $CONFIG_FILE..."

> "$CONFIG_FILE"
echo "# Auto-generated by configure script" >> "$CONFIG_FILE"
echo "" >> "$CONFIG_FILE"
echo "IPE := java -jar $IPE_PATH" >> "$CONFIG_FILE"
echo "XC8 := $XC8_PATH" >> "$CONFIG_FILE"
echo "DFP := $DFP_PATH/xc8" >> "$CONFIG_FILE"

echo "Done."
